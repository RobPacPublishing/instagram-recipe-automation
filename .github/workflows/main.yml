name: Generate Recipe Images
on:
  schedule:
    # Esegui ogni giorno alle 11:00 UTC
    - cron: '0 11 * * *'
  # Consente l'esecuzione manuale dal tab Actions
  workflow_dispatch:
jobs:
  generate-images:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      
      - name: Create package.json
        run: |
          echo '{
            "name": "instagram-recipe-automation",
            "version": "1.0.0",
            "description": "Automation for Instagram recipes",
            "dependencies": {
              "dotenv": "^16.0.0",
              "canvas": "^2.9.0"
            }
          }' > package.json
      
      - name: Install dependencies
        run: npm install
      
      - name: Install canvas dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpango1.0-dev libgif-dev build-essential g++
      
      - name: Create directories
        run: mkdir -p data/images
      
      - name: Create simple test image
        run: |
          cat > test-image.js << 'EOL'
          const fs = require('fs');
          const { createCanvas } = require('canvas');
          
          // Crea un'immagine di test
          const canvas = createCanvas(1080, 1080);
          const ctx = canvas.getContext('2d');
          
          // Sfondo
          ctx.fillStyle = '#F5F5DC';
          ctx.fillRect(0, 0, 1080, 1080);
          
          // Testo
          ctx.fillStyle = '#8B4513';
          ctx.font = 'bold 60px Arial';
          ctx.textAlign = 'center';
          ctx.fillText('Ricetta di Test', 540, 200);
          
          // Salva l'immagine
          const buffer = canvas.toBuffer('image/png');
          fs.writeFileSync('data/images/test-recipe.png', buffer);
          
          console.log('Immagine di test creata con successo!');
          EOL
          
          node test-image.js
      
      - name: Upload generated files
        uses: actions/upload-artifact@master
        with:
          name: generated-recipe-images
          path: data/images/
